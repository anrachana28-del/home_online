<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Register + OTP + Google Login</title>
<style>
body { font-family:"Khmer OS Battambang", Arial; background:#f4f6f9; margin:0; padding:0; }
h1{text-align:center; margin-top:20px;}
button { padding:10px; border:none; border-radius:5px; background:#1976d2; color:white; cursor:pointer; width:100%; margin:5px 0; }
button:hover { background:#1565c0; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:white; padding:20px; border-radius:10px; width:90%; max-width:400px; animation: fadeIn 0.3s; }
@keyframes fadeIn { from {opacity:0; transform: translateY(-50px);} to {opacity:1; transform: translateY(0);} }
input { width:100%; padding:10px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
#userInfo { text-align:center; margin:20px;}
</style>
</head>
<body>

<h1>ចុះឈ្មោះ + OTP SMS + Google Login</h1>

<div style="text-align:center; margin:20px;">
  <button onclick="openRegister()">ចុះឈ្មោះ</button>
  <button onclick="googleLogin()">Login ជា Google</button>
</div>

<div id="userInfo"></div>

<!-- Register Modal -->
<div id="registerModal" class="modal">
  <div class="modal-content">
    <span style="float:right; cursor:pointer;" onclick="closeRegister()">&times;</span>
    <h2>ចុះឈ្មោះ</h2>
    <input type="text" id="fullName" placeholder="Full Name">
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <input type="tel" id="phone" placeholder="លេខទូរស័ព្ទ +855...">
    <div id="recaptcha-container"></div>
    <button onclick="registerUser()">ចុះឈ្មោះ</button>
  </div>
</div>

<!-- OTP Modal -->
<div id="otpModal" class="modal">
  <div class="modal-content">
    <h2>បញ្ចូល OTP</h2>
    <input type="text" id="otpInput" placeholder="OTP">
    <button onclick="verifyOTP()">ផ្ទៀងផ្ទាត់</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAQMzAH4MJMojdHWAiLkYBSjdMJWS3Kccw",
  authDomain: "prewedding-f511a.firebaseapp.com",
  projectId: "prewedding-f511a",
  storageBucket: "prewedding-f511a.appspot.com",
  messagingSenderId: "1057725115554",
  appId: "1:1057725115554:web:4e8a48eaf959cbd9a07bfb"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Modal controls
function openRegister(){ document.getElementById("registerModal").style.display="flex"; }
function closeRegister(){ document.getElementById("registerModal").style.display="none"; }
function openOTP(){ document.getElementById("otpModal").style.display="flex"; }
function closeOTP(){ document.getElementById("otpModal").style.display="none"; }

// Temp user
let tempUser = null;
let confirmationResult = null;

// Register user
function registerUser(){
  const fullName = document.getElementById("fullName").value.trim();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;
  const phone = document.getElementById("phone").value.trim();

  if(!fullName || !username || !password || !phone){ alert("សូមបំពេញទាំងអស់!"); return; }

  tempUser = { fullName, username, password, phone };

  // Clear previous reCAPTCHA
  if(window.recaptchaVerifier) window.recaptchaVerifier.clear();

  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
    'size': 'invisible',
    'callback': (response) => { sendOTP(phone); }
  });

  sendOTP(phone);
}

// Send OTP
function sendOTP(phone){
  const appVerifier = window.recaptchaVerifier;
  auth.signInWithPhoneNumber(phone, appVerifier)
    .then((result) => {
      confirmationResult = result;
      openOTP();
      alert("OTP ត្រូវបានផ្ញើទៅលេខទូរស័ព្ទ!"); // dev only
    })
    .catch((error)=>{
      console.error(error);
      alert("មានបញ្ហា OTP: " + error.message);
    });
}

// Verify OTP
function verifyOTP(){
  const otp = document.getElementById("otpInput").value.trim();
  if(!otp){ alert("សូមបញ្ចូល OTP"); return; }

  confirmationResult.confirm(otp).then((result)=>{
    const user = result.user;
    // Save user to Firestore
    db.collection("users").doc(user.uid).set({
      fullName: tempUser.fullName,
      username: tempUser.username,
      phone: tempUser.phone,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
      alert("ចុះឈ្មោះសម្រេច!");
      closeOTP(); closeRegister();
      updateUI(user);
    });
  }).catch((error)=>{
    alert("OTP មិនត្រឹមត្រូវ: " + error.message);
  });
}

// Google Login
function googleLogin(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then((result)=>{
      const user = result.user;
      // Save Firestore
      db.collection("users").doc(user.uid).set({
        fullName: user.displayName,
        username: user.email,
        phone: user.phoneNumber || '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true }).then(()=>updateUI(user));
    })
    .catch((error)=>alert("Login មិនបាន: "+error.message));
}

// Session check & update UI
function updateUI(user){
  document.getElementById("userInfo").innerHTML = `
    <h3>សូមស្វាគមន៍, ${user.displayName || tempUser.fullName}</h3>
    <p>Username: ${user.email || tempUser.username}</p>
    <p>Phone: ${user.phoneNumber || tempUser.phone}</p>
    <button onclick="logout()">Logout</button>
  `;
  document.querySelectorAll("button[onclick='openRegister()'], button[onclick='googleLogin()']").forEach(b=>b.style.display='none');
}

// Logout
function logout(){
  auth.signOut().then(()=>{
    tempUser = null;
    confirmationResult = null;
    document.getElementById("userInfo").innerHTML = '';
    document.querySelectorAll("button[onclick='openRegister()'], button[onclick='googleLogin()']").forEach(b=>b.style.display='inline-block');
  });
}

// Check session on load
auth.onAuthStateChanged(user=>{
  if(user) updateUI(user);
});
</script>

</body>
</html>
