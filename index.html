<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Invoice - Admin</title>
<style>
/* === Base Styles === */
body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin:0; padding:20px; }
h3 { text-align:center; color:#333; font-size:1.6em; margin-bottom:20px; }

/* Buttons */
button { cursor:pointer; border:none; border-radius:5px; padding:12px 20px; font-size:16px; margin:10px; }
.login-btn { background:#4CAF50; color:white; }
.logout-btn { background:#f44336; color:white; }
.print-btn { background:#2196F3; color:white; }

/* Modal */
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal.show { display:flex; }
.modal-content { background:#fff; padding:25px; border-radius:15px; width:90%; max-width:400px; position:relative; box-shadow:0 5px 25px rgba(0,0,0,0.3); }
.close-btn { position:absolute; top:10px; right:15px; font-size:26px; background:none; border:none; cursor:pointer; color:#888; }
.close-btn:hover { color:#f44336; }

input { width:100%; padding:12px; margin:10px 0; border-radius:50px; border:1px solid #ccc; font-size:16px; }
input:focus { outline:none; border-color:#4CAF50; box-shadow:0 0 8px rgba(76,175,80,0.3); }

#loginMsg { text-align:center; margin-top:10px; font-weight:bold; }

/* Invoice Card */
.order-card { background:#fff; padding:20px; border-radius:15px; margin:20px auto; max-width:900px; box-shadow:0 6px 20px rgba(0,0,0,0.15); border-top:5px solid #4CAF50; overflow-x:auto; }
.order-card h4 { margin-top:0; color:#4CAF50; font-size:1.4em; }
.order-card table { width:100%; border-collapse: collapse; margin-top:15px; min-width:350px; }
.order-card th, .order-card td { border:1px solid #ddd; padding:10px; text-align:left; font-size:14px; }
.order-card th { background:#f0f0f0; color:#333; font-weight:bold; }
.order-card tr:nth-child(even){background:#f9f9f9;}
.order-card .total { font-weight:bold; color:#e91e63; text-align:right; font-size:16px; }
.order-card .customer-info { margin-bottom:15px; font-size:14px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
.order-card a { color:#2196F3; text-decoration:none; }
.order-card a:hover { text-decoration:underline; }

/* === Responsive Styles === */
@media (max-width:768px){
  body { padding:10px; }
  .order-card { padding:15px; border-radius:12px; }
  .order-card .customer-info { grid-template-columns: 1fr; font-size:14px; }
  table, th, td { font-size:13px; padding:8px; }
  button { width:100%; margin:8px 0; }
}

@media (min-width:769px){
  .order-card { padding:25px; border-radius:20px; }
  .order-card .customer-info { font-size:15px; }
  table, th, td { font-size:15px; padding:12px; }
}

/* Print Styles */
@media print {
  body { background: #fff; padding:0; }
  button, .modal { display: none; }
  .order-card { box-shadow: none; border-top: none; }
  table { page-break-inside: avoid; }
}
</style>
</head>
<body>

<h3>Admin Panel - Order Invoice</h3>
<button onclick="openModal()">Open Admin Login</button>

<!-- Admin Login Modal -->
<div id="adminModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()">&times;</button>
    <h3>Admin Login</h3>
    <input type="email" id="adminEmail" placeholder="Email">
    <input type="password" id="adminPassword" placeholder="Password">
    <button class="login-btn" onclick="adminLogin()">Login</button>
    <button class="logout-btn" onclick="adminLogout()">Logout</button>
    <div id="loginMsg"></div>
  </div>
</div>

<div id="searchResults">Please login to view orders.</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAQMzAH4MJMojdHWAiLkYBSjdMJWS3Kccw",
  authDomain: "prewedding-f511a.firebaseapp.com",
  projectId: "prewedding-f511a",
  storageBucket: "prewedding-f511a.appspot.com",
  messagingSenderId: "1057725115554",
  appId: "1:1057725115554:web:4e8a48eaf959cbd9a07bfb"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Modal
const modal = document.getElementById('adminModal');
function openModal(){ modal.classList.add('show'); }
function closeModal(){ modal.classList.remove('show'); }

// URL params
const urlParams = new URLSearchParams(window.location.search);
const searchCustomerID = urlParams.get('customerID');
const searchOrderCode = urlParams.get('orderCode');

// Admin Login
async function adminLogin(){
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPassword').value.trim();
  const msg = document.getElementById('loginMsg');
  msg.textContent='';
  if(!email||!pass){ msg.style.color='red'; msg.textContent='Enter email and password'; return; }

  try{
    await auth.signInWithEmailAndPassword(email,pass);
    msg.style.color='green'; msg.textContent='Login successful!';
    closeModal();
    fetchOrder();
  } catch(err){ 
    msg.style.color='red'; 
    msg.textContent='Login failed: '+err.message; 
    console.error(err); 
  }
}

// Admin Logout
function adminLogout(){
  auth.signOut().then(()=>{
    const msg=document.getElementById('loginMsg');
    msg.style.color='green';
    msg.textContent='Logged out successfully.';
    document.getElementById('searchResults').innerHTML="Please login to view orders.";
    openModal();
  }).catch(err=>{
    const msg=document.getElementById('loginMsg');
    msg.style.color='red';
    msg.textContent='Logout failed: '+err.message;
  });
}

// Fetch order
async function fetchOrder(){
  const container=document.getElementById('searchResults');
  const user = auth.currentUser;
  if(!user){ container.innerHTML="Please login as admin to view orders."; return; }
  if(!searchCustomerID || !searchOrderCode){ container.innerHTML="<p>Please provide Customer ID and Order Code in URL.</p>"; return; }

  try{
    const query=db.collectionGroup('orders')
      .where('customer.customID','==',searchCustomerID)
      .where('orderCode','==',searchOrderCode);

    const snap=await query.get();
    if(snap.empty){ container.innerHTML="<p>No order found.</p>"; return; }

    container.innerHTML="";
    snap.forEach(doc=>{
      const order=doc.data();
      const card=document.createElement('div');
      card.className='order-card';

      const productsRows = order.products.map(p => `
        <tr>
          <td>${p.name}</td>
          <td>${p.qty}</td>
          <td>$${Number(p.price).toFixed(2)}</td>
          <td>$${(Number(p.price)*Number(p.qty)).toFixed(2)}</td>
        </tr>`).join('');

      const baseURL = window.location.origin + window.location.pathname;
      const orderLink = `${baseURL}?customerID=${encodeURIComponent(order.customer.customID)}&orderCode=${encodeURIComponent(order.orderCode)}`;

      card.innerHTML=`
        <div class="customer-info">
          <div><b>Order Code:</b> ${order.orderCode}</div>
          <div><b>Customer ID:</b> ${order.customer.customID}</div>
          <div><b>Name:</b> ${order.customer.name}</div>
          <div><b>Phone:</b> ${order.customer.phone}</div>
          <div><b>Address:</b> ${order.customer.address}</div>
          <div><b>Email:</b> ${order.customer.email||'N/A'}</div>
          <div><b>View Online:</b> <a href="${orderLink}" target="_blank">Click to view</a></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            ${productsRows}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="total">Total</td>
              <td class="total">$${Number(order.total).toFixed(2)}</td>
            </tr>
          </tfoot>
        </table>

        <small>Created at: ${order.createdAt?.toDate ? order.createdAt.toDate().toLocaleString():'N/A'}</small>
        <br>
        <button class="print-btn" onclick="printInvoice(this)">Print Invoice</button>
      `;
      container.appendChild(card);
    });

  } catch(err){ 
    console.error(err); 
    container.innerHTML="<p style='color:red;'>Error fetching order.</p>"; 
  }
}

// Print only this invoice card
function printInvoice(btn) {
  const invoice = btn.closest('.order-card');
  if (!invoice) return;

  const originalContent = document.body.innerHTML;
  document.body.innerHTML = invoice.outerHTML;
  window.print();
  document.body.innerHTML = originalContent;
  window.location.reload(); // optional: reload JS to restore event listeners
}


// Auto fetch if already logged in
auth.onAuthStateChanged(user=>{ if(user) fetchOrder(); });
</script>
</body>
</html>
