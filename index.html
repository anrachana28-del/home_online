<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Lookup - Admin Modal</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
h3 { text-align: center; margin-bottom: 20px; }

/* Modal overlay */
.modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#fff; padding:20px; border-radius:10px; max-width:500px; width:90%; box-shadow:0 2px 10px rgba(0,0,0,0.2); position:relative; }
.close-btn { position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px; background:none; border:none; }

input { width: 100%; padding:8px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
button { padding:10px; width:100%; border:none; border-radius:5px; cursor:pointer; }
.login-btn { background:#4CAF50; color:white; margin-top:5px; }
.logout-btn { background:#f44336; color:white; margin-top:5px; }

.order-card ul { padding-left:20px; }
.order-card li { margin-bottom:4px; }
#searchResults { margin-top:20px; }
</style>
</head>
<body>

<h3>Admin Panel</h3>
<button onclick="openModal()">Open Admin Login</button>

<!-- Modal -->
<div id="adminModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()">&times;</button>
    <h3>Admin Login</h3>
    <input type="email" id="adminEmail" placeholder="Admin Email">
    <input type="password" id="adminPassword" placeholder="Password">
    <button class="login-btn" onclick="adminLogin()">Login</button>
    <button class="logout-btn" onclick="adminLogout()">Logout</button>
    <div id="loginMsg" style="color:red; margin-top:10px;"></div>
  </div>
</div>

<div id="searchResults">Please login to view orders.</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAQMzAH4MJMojdHWAiLkYBSjdMJWS3Kccw",
  authDomain: "prewedding-f511a.firebaseapp.com",
  projectId: "prewedding-f511a",
  storageBucket: "prewedding-f511a.appspot.com",
  messagingSenderId: "1057725115554",
  appId: "1:1057725115554:web:4e8a48eaf959cbd9a07bfb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Modal functions
function openModal() { document.getElementById('adminModal').style.display = 'flex'; }
function closeModal() { document.getElementById('adminModal').style.display = 'none'; }

// Parse query params
const urlParams = new URLSearchParams(window.location.search);
const searchCustomerID = urlParams.get('customerID');
const searchOrderCode = urlParams.get('orderCode');

// Admin Login
async function adminLogin() {
  const email = document.getElementById('adminEmail').value.trim();
  const pass = document.getElementById('adminPassword').value.trim();
  const msg = document.getElementById('loginMsg');
  msg.textContent = '';

  if (!email || !pass) { msg.textContent="Please enter email and password."; return; }

  try {
    await auth.signInWithEmailAndPassword(email, pass);
    msg.style.color = "green";
    msg.textContent = "Login successful!";
    closeModal();
    fetchOrder();
  } catch (err) {
    console.error(err);
    msg.style.color = "red";
    msg.textContent = "Login failed: " + err.message;
  }
}

// Admin Logout
function adminLogout() {
  auth.signOut().then(() => {
    const msg = document.getElementById('loginMsg');
    msg.style.color = "green";
    msg.textContent = "Logged out successfully.";
    document.getElementById('searchResults').innerHTML = "Please login to view orders.";
  }).catch(err => {
    console.error(err);
    document.getElementById('loginMsg').style.color = "red";
    document.getElementById('loginMsg').textContent = "Logout failed: " + err.message;
  });
}

// Fetch orders
async function fetchOrder() {
  const container = document.getElementById('searchResults');
  const user = auth.currentUser;
  if (!user) { container.innerHTML = "Please login as admin to view orders."; return; }
  if (!searchCustomerID || !searchOrderCode) { container.innerHTML = "<p>Please provide Customer ID and Order Code in URL.</p>"; return; }

  try {
    const query = db.collectionGroup('orders')
      .where('customer.customID','==',searchCustomerID)
      .where('orderCode','==',searchOrderCode);

    const snap = await query.get();
    if (snap.empty) { container.innerHTML="<p>No order found.</p>"; return; }

    container.innerHTML="";
    snap.forEach(doc=>{
      const order=doc.data();
      const orderEl=document.createElement('div');
      orderEl.className="order-card";
      orderEl.innerHTML=`
        <b>Order Code:</b> ${order.orderCode}<br>
        <b>Customer ID:</b> ${order.customer.customID}<br>
        <b>Name:</b> ${order.customer.name}<br>
        <b>Phone:</b> ${order.customer.phone}<br>
        <b>Address:</b> ${order.customer.address}<br>
        <b>Email:</b> ${order.customer.email||"N/A"}<br>
        <b>Total:</b> $${order.total.toFixed(2)}<br>
        <b>Products:</b><ul>
          ${order.products.map(p=>`<li>${p.name} x${p.qty} = $${(p.price*p.qty).toFixed(2)}</li>`).join('')}
        </ul>
        <small>Created at: ${order.createdAt?.toDate?order.createdAt.toDate().toLocaleString():"N/A"}</small>
      `;
      container.appendChild(orderEl);
    });

  } catch(err) { console.error(err); container.innerHTML="<p>Error fetching order.</p>"; }
}

// Auto fetch if logged in
auth.onAuthStateChanged(user=>{ if(user) fetchOrder(); });
</script>

</body>
</html>
