<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shop Home</title>
<style>
body {
  margin:0;
  font-family:Arial,Khmer OS Battambang;
  background: linear-gradient(to bottom right, #daf6f6e4);
  scroll-behavior: smooth; /* Smooth scroll */
}

header{
  background: linear-gradient(to bottom right, #c9bdbd, #0697cca7);
  color:#5c5c5cee;
  padding:5px;
  text-align:center;
  font-size:16px;
  font-weight:bold;
}

main {
  padding:10px;
  max-width:1200px;
  margin: auto;           /* margin-top:0 */
  background: rgba(255, 255, 255, 0.794);
  border-radius:0px;       /* 8px ឬ 10px ស្អាតជាង 1px */
  min-height: 90vh;
  overflow-y: auto;
}


.search-bar {
  margin: 15px 0;
  text-align: center;
}

.search-bar input {
  width: 20%;
  max-width: 200px;
  padding: 10px 15px;
  font-size: 12px;
  border-radius: 25px;
  border: 1px solid #ccc;
  outline: none;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15); /* shadow ដើម្បីទម្លាក់ក្រោម */
  transition: all 0.25s ease;
}

/* ពេល hover → shadow ច្បាស់ជាង */
.search-bar input:hover {
  box-shadow: 0 5px 10px rgba(0,0,0,0.2);
}

/* ពេល focus → ធ្វើអោយ border ពណ៌ខៀវ និងទម្លាក់ក្រោមជាង */
.search-bar input:focus {
  border-color: #0697cc;
  box-shadow: 0 6px 12px rgba(0, 151, 204, 0.35);
}

.filter-bar {
  text-align: left;         /* ចូលដាក់ left ដើម្បី scroll តាមលំដាប់ */
  margin: 10px 0 20px;
  overflow-x: auto;         /* អនុញ្ញាតឲ្យ scroll តាមអក្ស horizontally */
  white-space: nowrap;      /* បង្ខំឲ្យ button នៅជាជួរ មិនចុះបន្ទាត់ */
  padding-bottom: 6px;      /* ផ្ដល់ទំហំខ្លះកុំឲ្យ scrollbar បិទ buttons */
}

.filter-bar::-webkit-scrollbar {
  height: 6px;              /* scrollbar ទំហំតូចស្អាត */
}
.filter-bar::-webkit-scrollbar-thumb {
  background: linear-gradient(to bottom right, #c9bdbd, #0697cca7);
  border-radius: 3px;
}
.filter-bar::-webkit-scrollbar-track {
  background: transparent;
}

.filter-bar .type-btn {
  display: inline-block;
  padding: 6px 14px;
  margin: 3px;
  border-radius: 20px;
  border: 1px solid #18d7f084;
  background: linear-gradient(to bottom right, #c9bdbd, #0697cca7);
  color: #fff8f8;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;      /* កុំឲ្យពាក្យនៅក្នុង button បែកជាច្រើនបន្ទាត់ */
}

.filter-bar .type-btn.active,
.filter-bar .type-btn:hover {
  background: #007bff;
  color: #fff;
  transform: scale(1.05);
}


.section {
  margin: 10px 0 15px;
  font-size: 12px;
  color:#7c8384c1;
  

}
.section h2 {
  margin: 10px 0 15px;
  font-size: 18px;
  color:#02719dcb;
  border-left: 5px solid #03a1c9f2;
  padding-left: 12px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
  gap:15px;
}

.card{
  background:#fff;
  border-radius:12px;
  overflow:hidden;
  cursor:pointer;
  transition: transform 0.4s ease, box-shadow 0.4s ease, background 0.4s ease;
  position:relative;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
}
.card:hover{
  transform: scale(1.05);
  box-shadow: 0 12px 20px rgba(120, 117, 117, 0.191);
  background: linear-gradient(to bottom right, #c9bdbd, #0697cca7);
}

.img-container {
  position: relative;
  overflow: hidden;
}
.img-container img {
  width: 100%;
  height: 230px;
  object-fit: cover;
  transition: transform 0.3s ease, opacity 0.6s ease;
  opacity:0;
}
.img-container img.loaded {
  opacity:1;
}
.img-container:hover img {
  transform: scale(1.1);
}
.img-overlay {
  position: absolute;
  top:0; left:0; width:100%; height:100%;
  background: linear-gradient(to bottom right, #c9bdbd, #0697cca7);
  color: #fff;
  display:flex; justify-content:center; align-items:center;
  font-weight: bold;
  font-size: 12px;
  opacity:0;
  transition: opacity 0.3s ease;
}
.img-container:hover .img-overlay { opacity:1; }

.card-body{padding:10px;}
.card-body h3{font-size:12px;margin:0 0 5px;}
.price{color:#dd1503bc;font-weight:bold;font-size:12px; }
.original-price {
  color: rgba(145, 143, 143, 0.883);
  text-decoration: line-through;
  margin-right: 5px;
}

.more-label{color:#007bff;cursor:pointer;font-size:12px;margin-top:5px;}
.new-label {
  position:absolute;top:8px;right:12px;
  background:#dc3546b3;color:#ffffff;font-size:10px;
  font-weight:bold;padding:2px 6px;border-radius:4px;
}

/* Responsive Mobile */
@media (max-width: 768px){
  .grid {grid-template-columns: repeat(auto-fill,minmax(140px,1fr));}
  .img-container img {height:120px;}
  .search-bar input {width:95%;}
  .filter-bar .type-btn {padding:5px 12px;font-size:13px;}
}
</style>
</head>
<body>
<header> 
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="🔍 Search products by name...">
  </div></header>
<main>
 

  <div class="filter-bar" id="typeButtonsContainer">
    <!-- Type buttons generated dynamically -->
  </div>

  <div class="section" id="newestSection">
    <h2>Newest Products</h2>
    <div class="grid" id="newestGrid"></div>
  </div>

  <div class="section" id="typeSection">
    <h2>Products by Type</h2>
    <div id="typesContainer"></div>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAQMzAH4MJMojdHWAiLkYBSjdMJWS3Kccw",
  authDomain: "prewedding-f511a.firebaseapp.com",
  projectId: "prewedding-f511a",
  storageBucket: "prewedding-f511a.appspot.com",
  messagingSenderId: "1057725115554",
  appId: "1:1057725115554:web:4e8a48eaf959cbd9a07bfb"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const newestGrid = document.getElementById("newestGrid");
const typesContainer = document.getElementById("typesContainer");
const typeButtonsContainer = document.getElementById("typeButtonsContainer");
const searchInput = document.getElementById("searchInput");

let products = [];
let filteredProducts = [];

async function loadProducts(){
  const snapshot = await getDocs(collection(db,"products"));
  products = [];
  snapshot.forEach(docSnap=>{
    products.push({id:docSnap.id,...docSnap.data()});
  });
  filteredProducts = [...products];
  populateTypeButtons();
  renderNewest();
  renderByType();
}

function populateTypeButtons(){
  const types = [...new Set(products.map(p=>p.type).filter(Boolean))];
  typeButtonsContainer.innerHTML = '';

  const allBtn = document.createElement("div");
  allBtn.className="type-btn active";
  allBtn.textContent="All";
  allBtn.dataset.type="";
  typeButtonsContainer.appendChild(allBtn);
  allBtn.addEventListener("click", ()=>{setActiveTypeButton(allBtn); filterProducts("");});

  types.forEach(t=>{
    const btn = document.createElement("div");
    btn.className="type-btn";
    btn.textContent=t;
    btn.dataset.type=t;
    typeButtonsContainer.appendChild(btn);
    btn.addEventListener("click", ()=>{setActiveTypeButton(btn); filterProducts(t);});
  });
}

function setActiveTypeButton(activeBtn){
  const buttons = typeButtonsContainer.querySelectorAll(".type-btn");
  buttons.forEach(b=>b.classList.remove("active"));
  activeBtn.classList.add("active");
}

function filterProducts(type){
  const q = searchInput.value.toLowerCase();
  filteredProducts = products.filter(p=>{
    const matchType = !type || p.type===type;
    const matchSearch = (p.name||"").toLowerCase().includes(q) || (p.description||"").toLowerCase().includes(q);
    return matchType && matchSearch;
  });
  renderNewest();
  renderByType();

  if(type){
    const typeSection = document.getElementById("typeSection");
    typeSection.scrollIntoView({behavior:"smooth"});
  }
}

searchInput.addEventListener("input", ()=>{
  const activeBtn = typeButtonsContainer.querySelector(".type-btn.active");
  const selectedType = activeBtn ? activeBtn.dataset.type : "";
  filterProducts(selectedType);
});

function createCard(p){
  const card = document.createElement("div");
  card.className="card";

  const imgContainer = document.createElement("div");
  imgContainer.className="img-container";
  const img = document.createElement("img");
  img.src = p.imageUrl || p.imageURL || "";
  img.alt = p.name || "";
  img.onload = ()=> img.classList.add("loaded");
  imgContainer.appendChild(img);

  const overlay = document.createElement("div");
  overlay.className="img-overlay";
  overlay.textContent="មើលបន្ថែម";
  imgContainer.appendChild(overlay);

  const createdAt = p.createdAt?.toDate ? p.createdAt.toDate() : (p.createdAt || new Date());
  if(((new Date())-createdAt)/1000/60 <= 1440){
    const newLabel = document.createElement("div");
    newLabel.className="new-label";
    newLabel.textContent="ថ្មីបំផុត";
    imgContainer.appendChild(newLabel);
  }

  const body = document.createElement("div");
  body.className="card-body";
  const title = document.createElement("h3");
  title.textContent=p.name || "";
  body.appendChild(title);
  
  // Price with Discount
  // Price with Discount
if(p.price){
  const priceDiv = document.createElement("div");
  priceDiv.className="price";

  // calculate final price
  const discount = p.discount || 0;
  const finalPrice = (p.price * (1 - discount/100)).toFixed(2);

  if(discount > 0){
    priceDiv.innerHTML = `<span class="original-price">$${p.price}</span> <strong>$${finalPrice}</strong> (-${discount}%)`;
  } else {
    priceDiv.textContent = `$${p.price}`;
  }

  body.appendChild(priceDiv);
}

  if(p.description){
    const short=p.description.length>16 ? p.description.substring(0, 16) : p.description;
    const desc=document.createElement("div");
    desc.textContent=short;
    body.appendChild(desc);
    if(p.description.length>16){
      const more=document.createElement("div");
      more.className="more-label";
      more.textContent="មើលបន្ថែម...";
      more.onclick = ()=> window.location.href=`view.html?id=${p.id}`;
      body.appendChild(more);
    }
  }
  

  card.appendChild(imgContainer);
  card.appendChild(body);

  card.addEventListener("click", e=>{
    if(!e.target.classList.contains("more-label")){
      window.location.href=`view.html?id=${p.id}`;
    }
  });

  return card;
}

// Render newest products
function renderNewest(){
  newestGrid.innerHTML="";
  let sorted=[...filteredProducts].sort((a,b)=>{
    const dA=a.createdAt?.toDate ? a.createdAt.toDate() : (a.createdAt||new Date(0));
    const dB=b.createdAt?.toDate ? b.createdAt.toDate() : (b.createdAt||new Date(0));
    return dB-dA;
  });
  sorted.slice(0,6).forEach(p=>newestGrid.appendChild(createCard(p)));
}

// Render products grouped by Type
function renderByType(){
  typesContainer.innerHTML="";
  const groups={};
  filteredProducts.forEach(p=>{
    if(!groups[p.type]) groups[p.type]=[];
    groups[p.type].push(p);
  });
  Object.keys(groups).forEach(type=>{
    const section=document.createElement("div");
    section.className="section";
    const h=document.createElement("h3");
    h.textContent=type;
    section.appendChild(h);
    const grid=document.createElement("div");
    grid.className="grid";
    groups[type].forEach(p=>grid.appendChild(createCard(p)));
    section.appendChild(grid);
    typesContainer.appendChild(section);
  });
}


await loadProducts();
</script>
</body>
</html>
