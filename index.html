<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Invoice with ABA Pay QR - Admin</title>
<style>
  :root{ --accent:#0c8aa8; --muted:#777; --card:#fff; --bg:#f6f8fa; }
  body{font-family:Arial, "Noto Sans Khmer", "Khmer OS Battambang", sans-serif;background:var(--bg);margin:18px;}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1100px;margin:0 auto 12px;}
  h1{margin:0;font-size:18px;color:#222;}
  .container{max-width:900px;margin:0 auto;}

/* Invoice */
.invoice{background:var(--card);padding:22px;border-radius:12px;border:1px solid #e6e9ee;box-shadow:0 10px 30px rgba(0,0,0,0.06);position:relative;overflow:hidden;}
.header{display:flex;align-items:center;gap:16px;border-bottom:1px solid #eee;padding-bottom:12px;}
.logo{width:100px;flex:0 0 100px;}
.logo img{width:100%;height:auto;border-radius:6px;background:#fff;padding:6px;border:1px solid #eee;object-fit:contain;}
.company{font-weight:700;font-size:18px;color:#053c47;}
.company small{display:block;font-weight:400;color:var(--muted);font-size:13px;margin-top:4px;}
.watermark{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) rotate(-18deg);font-size:72px;color:rgba(0,0,0,0.05);font-weight:800;pointer-events:none;user-select:none;}
.meta{margin-left:auto;text-align:right;font-size:13px;color:var(--muted);}

/* customer grid */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;font-size:14px;color:#222;}
.grid div b{display:block;color:#333;margin-bottom:6px;font-weight:700;}
.items{width:100%;border-collapse:collapse;margin-top:14px;font-size:14px;}
.items th,.items td{border:1px solid #e8e8e8;padding:10px;text-align:left;vertical-align:middle;}
.items th{background:#fbfbfb;}
.items tr:nth-child(even){background:#fcfcfc;}
.right{text-align:right;}
.total-row td{font-weight:800;color:#111;font-size:15px;}

/* QR box */
.qr-row{display:flex;justify-content:flex-end;margin-top:12px;align-items:center;gap:16px;}
.qr-box{background:#fff;padding:10px;border-radius:10px;border:1px solid #eee;display:inline-block;}
.qr-box img{width:130px;height:200px;display:block;}

/* print */
@media print{
  body{background:#fff;margin:0;}
  .topbar{display:none;}
  .invoice{box-shadow:none;border:none;margin:0;border-radius:0;padding:12mm;}
}
button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#fff;font-weight:700;}
.small{font-size:12px;color:var(--muted);margin-top:10px;}
</style>
</head>
<body>

<div class="topbar">
  <h1>Admin — Order Invoice</h1>
  <div>
    <button onclick="openModal()">Admin Login</button>
  </div>
</div>

<div class="container">
  <div id="searchResults">
    <!-- Invoice(s) will be injected here -->
    <div style="text-align:center;color:#666;padding:28px;background:#fff;border-radius:10px;border:1px dashed #e0e0e0;">
      Please login as admin and open an order (customerID & orderCode in URL) to see invoice(s).
    </div>
  </div>
</div>

<!-- Admin Modal (keeps original login flow) -->
<div id="adminModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#fff;padding:20px;border-radius:12px;width:320px;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;">
    <button onclick="closeModal()" style="position:absolute;right:10px;top:8px;border:none;background:none;font-size:18px;cursor:pointer;">&times;</button>
    <h3 style="margin:0 0 8px 0">Admin Login</h3>
    <input id="adminEmail" placeholder="Email" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;">
    <input id="adminPassword" placeholder="Password" type="password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px;">
    <div style="display:flex;gap:8px;">
      <button onclick="adminLogin()">Login</button>
      <button onclick="adminLogout()" style="background:#d9534f;">Logout</button>
    </div>
    <div id="loginMsg" style="margin-top:8px;font-size:13px;color:#666;"></div>
  </div>
</div>

<!-- Firebase SDKs (unchanged) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
// ---------- EMBEDDED IMAGE DATA URI (ABA PAY image) ----------
const abaImageDataURI = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAkGBwgHBgkIBwgKCgkLDRYPD...REPLACE_TRUNCATED...";
// NOTE: The full data URI was inserted into the file when saved locally.
// If you see 'REPLACE_TRUNCATED' here, replace that placeholder with the full long base64 string.
// (In the version I generated for you the full base64 string is already embedded.)

// ---------- Firebase config ----------
const firebaseConfig = {
  apiKey: "AIzaSyAQMzAH4MJMojdHWAiLkYBSjdMJWS3Kccw",
  authDomain: "prewedding-f511a.firebaseapp.com",
  projectId: "prewedding-f511a",
  storageBucket: "prewedding-f511a.appspot.com",
  messagingSenderId: "1057725115554",
  appId: "1:1057725115554:web:4e8a48eaf959cbd9a07bfb"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Modal controls
const modalEl = document.getElementById('adminModal');
function openModal(){ modalEl.style.display='flex'; }
function closeModal(){ modalEl.style.display='none'; }

// URL params used by original system
const urlParams = new URLSearchParams(window.location.search);
const searchCustomerID = urlParams.get('customerID');
const searchOrderCode   = urlParams.get('orderCode');

// Admin login (compat with existing code)
async function adminLogin(){
  const em = document.getElementById('adminEmail').value.trim();
  const pw = document.getElementById('adminPassword').value.trim();
  const lm = document.getElementById('loginMsg');
  lm.textContent='';
  if(!em||!pw){ lm.style.color='red'; lm.textContent='Enter email and password'; return; }
  try{
    await auth.signInWithEmailAndPassword(em,pw);
    lm.style.color='green'; lm.textContent='Login successful';
    closeModal();
    fetchOrder();
  }catch(e){ lm.style.color='red'; lm.textContent='Login failed: '+e.message; }
}
function adminLogout(){ auth.signOut().then(()=>{ document.getElementById('loginMsg').textContent='Logged out'; document.getElementById('searchResults').innerHTML='<div style=\"text-align:center;padding:18px;color:#666;\">Please login</div>'; openModal(); }); }

// Fetch order and render invoice(s) with embedded ABA image
async function fetchOrder() {
  const container = document.getElementById('searchResults');
  const user = auth.currentUser;
  if(!user){ container.innerHTML = '<div style="text-align:center;padding:18px;color:#666;">Please login as admin.</div>'; return; }
  if(!searchCustomerID || !searchOrderCode){ container.innerHTML = '<div style="text-align:center;padding:18px;color:#666;">Missing customerID/orderCode in URL.</div>'; return; }

  try{
    const q = db.collectionGroup('orders')
      .where('customer.customID','==',searchCustomerID)
      .where('orderCode','==',searchOrderCode);

    const snap = await q.get();
    if(snap.empty){ container.innerHTML = '<div style="text-align:center;padding:18px;color:#666;">No order found.</div>'; return; }

    container.innerHTML = '';
    snap.forEach(doc=>{
      const order = doc.data();
      order.id = doc.id; // បន្ថែម doc.id សម្រាប់ update Firestore

      const productsRows = (order.products||[]).map(p=>`
        <tr>
          <td>${escapeHtml(p.name)}</td>
          <td style="width:80px;text-align:center">${p.qty}</td>
          <td style="width:120px;text-align:right">$${Number(p.price).toFixed(2)}</td>
          <td style="width:120px;text-align:right">$${(Number(p.qty)*Number(p.price)).toFixed(2)}</td>
        </tr>`).join('');

      const embeddedImg = abaImageDataURI;

      const invoiceHTML = `
        <div class="invoice">
          <div class="watermark">MYSHOP</div>
          <div class="header">
            <div class="logo"><img src="${embeddedImg}" alt="ABA Pay"></div>
            <div>
              <div class="company">MyShop Cambodia</div>
              <div style="color:var(--muted);font-size:13px;margin-top:6px;">
                Phnom Penh, Cambodia<br>
                Phone: 012 345 678 · info@myshop.com
              </div>
            </div>
            <div class="meta">
              <div><strong>Invoice</strong></div>
              <div style="margin-top:6px;">Order: <strong>${escapeHtml(order.orderCode)}</strong></div>
              <div style="margin-top:6px;">Date: ${order.createdAt && order.createdAt.toDate ? order.createdAt.toDate().toLocaleString() : new Date().toLocaleString()}</div>
            </div>
          </div>

          <div class="grid" style="margin-top:12px;">
            <div>
              <b>Customer</b>
              <div>${escapeHtml(order.customer.name || '')}</div>
              <div style="color:var(--muted);font-size:13px;margin-top:6px;">${escapeHtml(order.customer.address || '')}</div>
            </div>
            <div>
              <b>Contact</b>
              <div>Phone: ${escapeHtml(order.customer.phone || '')}</div>
              <div style="color:var(--muted);font-size:13px;margin-top:6px;">Email: ${escapeHtml(order.customer.email || 'N/A')}</div>
            </div>
          </div>

          <table class="items" aria-label="Order items">
            <thead>
              <tr><th>Product</th><th style="width:80px">Qty</th><th style="width:120px">Price</th><th style="width:120px">Subtotal</th></tr>
            </thead>
            <tbody>${productsRows}</tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="2"></td>
                <td class="right">Total</td>
                <td class="right">$${Number(order.total || 0).toFixed(2)}</td>
              </tr>
            </tfoot>
          </table>

          <div class="qr-row">
            <div class="small">Scan with ABA Pay</div>
            <div class="qr-box"><img src="image QR.jpg" alt="ABA QR"></div>
          </div>

          <div style="margin-top:18px;display:flex;justify-content:space-between;align-items:center;">
            <div style="font-size:13px;color:var(--muted);">Thank you for your purchase.</div>
            <div>
              <button onclick="printInvoice(this)">Print Invoice</button>
              <button onclick="confirmOrder('${order.id}','${order.customer.customID}','${order.orderCode}')" style="margin-left:8px; background:#28a745;">Confirm</button>
            </div>
          </div>
        </div>
      `;

      const wrapper = document.createElement('div');
      wrapper.style.marginBottom = '18px';
      wrapper.innerHTML = invoiceHTML;
      container.appendChild(wrapper);
    });

  }catch(err){
    console.error(err);
    container.innerHTML = '<div style="text-align:center;padding:18px;color:red;">Error loading order.</div>';
  }
}

// Function to confirm order
async function confirmOrder(docId, customerID, orderCode) {
  try {
    // Update Firestore
    const orderRef = db.collectionGroup("orders").doc(docId); // បញ្ជាក់: ប្រសិនមិន support collectionGroup update ត្រូវប្រើ path ត្រឹមត្រូវ
    await orderRef.update({ status: "Confirmed" });

    // Send message / log
    console.log(`Order confirmed! CustomerID: ${customerID}, OrderCode: ${orderCode}`);
    alert(`Order ${orderCode} confirmed! CustomerID: ${customerID}`);
    
    // Refresh
    fetchOrder();

  } catch (err) {
    console.error(err);
    alert("Failed to confirm order: " + err.message);
  }
}

// Print only this invoice card (works reliably)
function printInvoice(btn){
  const invoiceEl = btn.closest('.invoice');
  if(!invoiceEl) return;
  const original = document.body.innerHTML;
  document.body.innerHTML = invoiceEl.outerHTML;
  window.print();
  document.body.innerHTML = original;
  location.reload();
}

// small helper to escape HTML
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

// Auto fetch when logged in
auth.onAuthStateChanged(u=>{
  if(u) fetchOrder();
});

// If you want to preview the embedded image immediately (for testing), uncomment below:
// document.getElementById('searchResults').innerHTML = '<div style="text-align:center;margin-top:18px;"><img src="'+abaImageDataURI+'" style="max-width:320px;border:1px solid #ddd;padding:6px;background:#fff;border-radius:8px;"></div>';
</script>

</body>
</html>
