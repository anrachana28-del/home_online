<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Invoice with ABA Pay QR - Admin</title>
<style>
:root{ --accent:#0c8aa8; --muted:#777; --card:#fff; --bg:#f6f8fa; }
body{font-family:Arial, "Noto Sans Khmer", "Khmer OS Battambang", sans-serif;background:var(--bg);margin:18px;}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1100px;margin:0 auto 12px;}
h1{margin:0;font-size:18px;color:#222;}
.container{max-width:900px;margin:0 auto;}
.invoice{background:var(--card);padding:22px;border-radius:12px;border:1px solid #e6e9ee;box-shadow:0 10px 30px rgba(0,0,0,0.06);position:relative;overflow:hidden;}
.header{display:flex;align-items:center;gap:16px;border-bottom:1px solid #eee;padding-bottom:12px;}
.logo{width:100px;flex:0 0 100px;}
.logo img{width:100%;height:auto;border-radius:6px;background:#fff;padding:6px;border:1px solid #eee;object-fit:contain;}
.company{font-weight:700;font-size:18px;color:#053c47;}
.watermark{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) rotate(-18deg);font-size:72px;color:rgba(0,0,0,0.05);font-weight:800;pointer-events:none;user-select:none;}
.meta{margin-left:auto;text-align:right;font-size:13px;color:var(--muted);}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;font-size:14px;color:#222;}
.grid div b{display:block;color:#333;margin-bottom:6px;font-weight:700;}
.items{width:100%;border-collapse:collapse;margin-top:14px;font-size:14px;}
.items th,.items td{border:1px solid #e8e8e8;padding:10px;text-align:left;vertical-align:middle;}
.items th{background:#fbfbfb;}
.items tr:nth-child(even){background:#fcfcfc;}
.right{text-align:right;}
.total-row td{font-weight:800;color:#111;font-size:15px;}
.qr-row{display:flex;justify-content:flex-end;margin-top:12px;align-items:center;gap:16px;}
.qr-box{background:#fff;padding:10px;border-radius:10px;border:1px solid #eee;display:inline-block;}
.qr-box img{width:130px;height:200px;display:block;}
@media print{body{background:#fff;margin:0;}.topbar{display:none;}.invoice{box-shadow:none;border:none;margin:0;border-radius:0;padding:12mm;}}
button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#fff;font-weight:700;}
.small{font-size:12px;color:var(--muted);margin-top:10px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;z-index:9999;}
.modal-content{background:#fff;padding:20px;border-radius:12px;width:360px;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;}
.modal-content button.close{position:absolute;right:10px;top:8px;border:none;background:none;font-size:18px;cursor:pointer;}
</style>
</head>
<body>

<div class="topbar">
  <h1>Admin â€” Order Invoice</h1>
  <div>
    <button onclick="openAdminModal()">Admin Login</button>
  </div>
</div>

<div class="container">
  <div id="searchResults">
    <div style="text-align:center;color:#666;padding:28px;background:#fff;border-radius:10px;border:1px dashed #e0e0e0;">
      Please login as admin and open an order (customerID & orderCode in URL) to see invoice(s).
    </div>
  </div>
</div>

<!-- Admin Login Modal -->
<div id="adminModal" class="modal">
  <div class="modal-content">
    <button class="close" onclick="closeAdminModal()">&times;</button>
    <h3>Admin Login</h3>
    <input id="adminEmail" placeholder="Email" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;">
    <input id="adminPassword" placeholder="Password" type="password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px;">
    <div style="display:flex;gap:8px;">
      <button onclick="adminLogin()">Login</button>
      <button onclick="adminLogout()" style="background:#d9534f;">Logout</button>
    </div>
    <div id="loginMsg" style="margin-top:8px;font-size:13px;color:#666;"></div>
  </div>
</div>

<!-- Order Modal -->
<div id="orderModal" class="modal">
  <div class="modal-content">
    <button class="close" onclick="closeOrderModal()">&times;</button>
    <div id="modalContent"></div>
    <div style="margin-top:10px; text-align:right;">
      <button id="confirmBtn" onclick="">Confirm</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAQMzAH4MJMojdHWAiLkYBSjdMJWS3Kccw",
  authDomain: "prewedding-f511a.firebaseapp.com",
  projectId: "prewedding-f511a",
  storageBucket: "prewedding-f511a.appspot.com",
  messagingSenderId: "1057725115554",
  appId: "1:1057725115554:web:4e8a48eaf959cbd9a07bfb"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const urlParams = new URLSearchParams(window.location.search);
const searchCustomerID = urlParams.get('customerID');
const searchOrderCode = urlParams.get('orderCode');

let currentOrder = null; // store current order object

function openAdminModal(){ document.getElementById('adminModal').style.display='flex'; }
function closeAdminModal(){ document.getElementById('adminModal').style.display='none'; }
function closeOrderModal(){ document.getElementById('orderModal').style.display='none'; }

async function adminLogin(){
  const em = document.getElementById('adminEmail').value.trim();
  const pw = document.getElementById('adminPassword').value.trim();
  const lm = document.getElementById('loginMsg');
  lm.textContent='';
  if(!em||!pw){ lm.style.color='red'; lm.textContent='Enter email and password'; return; }
  try{
    await auth.signInWithEmailAndPassword(em,pw);
    lm.style.color='green'; lm.textContent='Login successful';
    closeAdminModal();
    fetchOrder();
  }catch(e){ lm.style.color='red'; lm.textContent='Login failed: '+e.message; }
}

function adminLogout(){
  auth.signOut().then(()=>{
    document.getElementById('loginMsg').textContent='Logged out';
    document.getElementById('searchResults').innerHTML='<div style="text-align:center;padding:18px;color:#666;">Please login</div>';
    openAdminModal();
  });
}

// Fetch order
async function fetchOrder(){
  const container = document.getElementById('searchResults');
  const user = auth.currentUser;
  if(!user){ container.innerHTML='<div style="text-align:center;padding:18px;color:#666;">Please login as admin.</div>'; return; }
  if(!searchCustomerID || !searchOrderCode){ container.innerHTML='<div style="text-align:center;padding:18px;color:#666;">Missing customerID/orderCode in URL.</div>'; return; }

  try{
    const q = db.collectionGroup('orders')
      .where('customer.customID','==',searchCustomerID)
      .where('orderCode','==',searchOrderCode);
    const snap = await q.get();
    if(snap.empty){ container.innerHTML='<div style="text-align:center;padding:18px;color:#666;">No order found.</div>'; return; }

    container.innerHTML='';
    snap.forEach(docSnap=>{
      const order = docSnap.data();
      order.docPath = docSnap.ref.path; // store full path
      const status = order.status || "Pending";
      const row = document.createElement('div');
      row.style.marginBottom='12px';
      row.innerHTML = `
        <div style="padding:10px;border:1px solid #ddd;border-radius:8px;background:#fff;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <b>Order:</b> ${order.orderCode} <br>
            <b>Customer:</b> ${order.customer.name} <br>
            <b>Status:</b> <span id="status-${order.orderCode}">${status}</span>
          </div>
          <div>
            <button onclick='showOrderModal(${JSON.stringify(order).replaceAll("'", "\\'")})'>View / Confirm</button>
          </div>
        </div>
      `;
      container.appendChild(row);
    });
  }catch(err){
    console.error(err);
    container.innerHTML='<div style="text-align:center;padding:18px;color:red;">Error loading order.</div>';
  }
}

// Show order modal
function showOrderModal(order){
  currentOrder = order;
  const modal = document.getElementById('orderModal');
  const content = document.getElementById('modalContent');
  const statusText = order.status || "Pending";

  content.innerHTML = `
    <h3>Order ${order.orderCode}</h3>
    <p><b>Customer:</b> ${order.customer.name}</p>
    <p><b>Phone:</b> ${order.customer.phone}</p>
    <p><b>Address:</b> ${order.customer.address}</p>
    <p><b>Email:</b> ${order.customer.email || 'N/A'}</p>
    <hr>
    <h4>Items:</h4>
    <div>
      ${(order.products||[]).map(p=>{
        const price=Number(p.price)||0, qty=Number(p.qty)||0;
        return `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;">
          <div style="flex:2;">${p.name}</div>
          <div style="flex:1;text-align:center;">${qty}</div>
          <div style="flex:1;text-align:right;">$${price.toFixed(2)}</div>
          <div style="flex:1;text-align:right;">$${(price*qty).toFixed(2)}</div>
        </div>`;
      }).join('')}
    </div>
    <hr>
    <p style="text-align:right;font-weight:bold;">Total: $${Number(order.total||0).toFixed(2)}</p>
    <p style="text-align:right;font-size:12px;color:#555;">${order.createdAt ? order.createdAt.toDate().toLocaleString() : ''}</p>
  `;
  const btn = document.getElementById('confirmBtn');
  btn.onclick = confirmOrder;
  modal.style.display='flex';
}

// Confirm order
async function confirmOrder(){
  if(!currentOrder) return;
  try{
    const ref = db.doc(currentOrder.docPath);
    await ref.update({status:"Confirmed"});
    alert("Order confirmed!");
    document.getElementById(`status-${currentOrder.orderCode}`).innerText="Confirmed";
    closeOrderModal();
  }catch(err){
    console.error("Failed to confirm order:", err);
    alert("Failed to confirm order: "+err.message);
  }
}

// Print invoice
function printInvoice(btn){
  const invoiceEl = btn.closest('.invoice');
  if(!invoiceEl) return;
  const original = document.body.innerHTML;
  document.body.innerHTML = invoiceEl.outerHTML;
  window.print();
  document.body.innerHTML = original;
  location.reload();
}

// Escape HTML
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

auth.onAuthStateChanged(u=>{
  if(u) fetchOrder();
});
</script>

</body>
</html>
