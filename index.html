<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Invoice with ABA Pay QR - Admin</title>
<style>
  :root{ --accent:#0c8aa8; --muted:#777; --card:#fff; --bg:#f6f8fa; }
  body{font-family:Arial, "Noto Sans Khmer", "Khmer OS Battambang", sans-serif;background:var(--bg);margin:18px;}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1100px;margin:0 auto 12px;}
  h1{margin:0;font-size:18px;color:#222;}
  .container{max-width:900px;margin:0 auto;}

/* Invoice */
.invoice{background:var(--card);padding:22px;border-radius:12px;border:1px solid #e6e9ee;box-shadow:0 10px 30px rgba(0,0,0,0.06);position:relative;overflow:hidden;}
.header{display:flex;align-items:center;gap:16px;border-bottom:1px solid #eee;padding-bottom:12px;}
.logo{width:100px;flex:0 0 100px;}
.logo img{width:100%;height:auto;border-radius:6px;background:#fff;padding:6px;border:1px solid #eee;object-fit:contain;}
.company{font-weight:700;font-size:18px;color:#053c47;}
.company small{display:block;font-weight:400;color:var(--muted);font-size:13px;margin-top:4px;}
.watermark{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) rotate(-18deg);font-size:72px;color:rgba(0,0,0,0.05);font-weight:800;pointer-events:none;user-select:none;}
.meta{margin-left:auto;text-align:right;font-size:13px;color:var(--muted);}

/* customer grid */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;font-size:14px;color:#222;}
.grid div b{display:block;color:#333;margin-bottom:6px;font-weight:700;}
.items{width:100%;border-collapse:collapse;margin-top:14px;font-size:14px;}
.items th,.items td{border:1px solid #e8e8e8;padding:10px;text-align:left;vertical-align:middle;}
.items th{background:#fbfbfb;}
.items tr:nth-child(even){background:#fcfcfc;}
.right{text-align:right;}
.total-row td{font-weight:800;color:#111;font-size:15px;}

/* status */
.status{padding:4px 8px;border-radius:6px;color:#fff;font-weight:700;font-size:12px;}
.status.Pending{background:#ff9800;}
.status.Confirmed{background:#28a745;}
.status.Cancelled{background:#d9534f;}

/* QR box */
.qr-row{display:flex;justify-content:flex-end;margin-top:12px;align-items:center;gap:16px;}
.qr-box{background:#fff;padding:10px;border-radius:10px;border:1px solid #eee;display:inline-block;}
.qr-box img{width:130px;height:200px;display:block;}

/* print */
@media print{
  body{background:#fff;margin:0;}
  .topbar{display:none;}
  .invoice{box-shadow:none;border:none;margin:0;border-radius:0;padding:12mm;}
}
button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#fff;font-weight:700;}
button.cancel{background:#d9534f;}
button.confirm{background:#28a745;}
.small{font-size:12px;color:var(--muted);margin-top:10px;}


.status {
  padding:4px 10px;
  border-radius:6px;
  font-weight:bold;
  color:white;
}

.status.Pending { background: orange; }
.status.Confirmed { background: green; }
.status.Cancelled { background: red; }

  
</style>
</head>
<body>

<div class="topbar">
  <h1>Admin — Order Invoice</h1>
  <div>
    <button onclick="openModal()">Admin Login</button>
  </div>
</div>

<div class="container">
  <div id="searchResults">
    <div style="text-align:center;color:#666;padding:28px;background:#fff;border-radius:10px;border:1px dashed #e0e0e0;">
      Please login as admin and open an order (customerID & orderCode in URL) to see invoice(s).
    </div>
  </div>
</div>

<!-- Admin Modal -->
<div id="adminModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#fff;padding:20px;border-radius:12px;width:320px;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;">
    <button onclick="closeModal()" style="position:absolute;right:10px;top:8px;border:none;background:none;font-size:18px;cursor:pointer;">&times;</button>
    <h3 style="margin:0 0 8px 0">Admin Login</h3>
    <input id="adminEmail" placeholder="Email" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;">
    <input id="adminPassword" placeholder="Password" type="password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px;">
    <div style="display:flex;gap:8px;">
      <button onclick="adminLogin()">Login</button>
      <button onclick="adminLogout()" style="background:#d9534f;">Logout</button>
    </div>
    <div id="loginMsg" style="margin-top:8px;font-size:13px;color:#666;"></div>
  </div>
</div>


  <!-- Confirm Modal -->
<div id="confirmModal" style="
  display:none;
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center; z-index:9999;
">
  <div style="background:white; padding:20px; width:300px; border-radius:8px; text-align:center;">
    <div id="modalMessage" style="font-size:16px; margin-bottom:20px;">Are you sure?</div>

    <button id="modalYes" style="background:green;color:white;padding:8px 15px;border:none;border-radius:5px;margin-right:8px;">
      Yes
    </button>

    <button onclick="closeModal()" style="background:red;color:white;padding:8px 15px;border:none;border-radius:5px;">
      Cancel
    </button>
  </div>
</div>
<button id="chatBtn" style="position:fixed;bottom:20px;right:20px;padding:12px 18px;border:none;border-radius:50px;background:#0c8aa8;color:white;font-weight:bold;cursor:pointer;">Chat</button>

<div id="chatModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);justify-content:center;align-items:center;z-index:9999;">
  <div style="width:320px;max-height:450px;background:#fff;border-radius:12px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
    <div style="background:#0c8aa8;color:white;padding:10px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;">
      Support Chat
      <button onclick="closeChat()" style="background:none;border:none;color:white;font-size:18px;cursor:pointer;">&times;</button>
    </div>
    <div id="chatMessages" style="flex:1;padding:10px;overflow-y:auto;font-size:13px;display:flex;flex-direction:column;"></div>
    <div style="display:flex;border-top:1px solid #ddd;">
      <input id="chatInput" type="text" placeholder="Type a message..." style="flex:1;padding:8px;border:none;outline:none;font-size:13px;">
      <button onclick="sendMessage()" style="background:#0c8aa8;color:white;border:none;padding:0 12px;cursor:pointer;">Send</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
// ---------- Embedded ABA Image ----------
const abaImageDataURI = "data:image/jpeg;base64,..."; // full base64 here

// ---------- Firebase config ----------
const firebaseConfig = {
  apiKey: "AIzaSyAQMzAH4MJMojdHWAiLkYBSjdMJWS3Kccw",
  authDomain: "prewedding-f511a.firebaseapp.com",
  projectId: "prewedding-f511a",
  storageBucket: "prewedding-f511a.appspot.com",
  messagingSenderId: "1057725115554",
  appId: "1:1057725115554:web:4e8a48eaf959cbd9a07bfb"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Modal controls
const modalEl = document.getElementById('adminModal');
function openModal(){ modalEl.style.display='flex'; }
function closeModal(){ modalEl.style.display='none'; }

// URL params
const urlParams = new URLSearchParams(window.location.search);
const searchCustomerID = urlParams.get('customerID');
const searchOrderCode   = urlParams.get('orderCode');

// Admin login/logout
async function adminLogin(){
  const em = document.getElementById('adminEmail').value.trim();
  const pw = document.getElementById('adminPassword').value.trim();
  const lm = document.getElementById('loginMsg');
  lm.textContent='';
  if(!em||!pw){ lm.style.color='red'; lm.textContent='Enter email and password'; return; }
  try{
    await auth.signInWithEmailAndPassword(em,pw);
    lm.style.color='green'; lm.textContent='Login successful';
    closeModal();
    fetchOrder();
  }catch(e){ lm.style.color='red'; lm.textContent='Login failed: '+e.message; }
}
function adminLogout(){ 
  auth.signOut().then(()=>{
    document.getElementById('loginMsg').textContent='Logged out';
    document.getElementById('searchResults').innerHTML='<div style="text-align:center;padding:18px;color:#666;">Please login</div>'; 
    openModal(); 
  }); 
}

// Escape HTML helper
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// Print invoice
function printInvoice(btn){
  const invoiceEl = btn.closest('.invoice');
  if(!invoiceEl) return;
  const original = document.body.innerHTML;
  document.body.innerHTML = invoiceEl.outerHTML;
  window.print();
  document.body.innerHTML = original;
  location.reload();
}
let modalAction = null;

function showModal(message, action){
  document.getElementById('modalMessage').textContent = message;
  modalAction = action;
  document.getElementById('confirmModal').style.display = 'flex';
}

function closeModal(){
  document.getElementById('confirmModal').style.display = 'none';
}

document.getElementById('modalYes').onclick = () => {
  if(modalAction) modalAction();
  closeModal();
};

// ---------- Fetch order & render ----------
// ----------- Fetch Order ------------
async function fetchOrder() {
  const container = document.getElementById('searchResults');
  const user = auth.currentUser;
  if(!user){
    container.innerHTML = "Please login as admin.";
    return;
  }

  try{
    const q = db.collectionGroup('orders')
      .where('customer.customID','==',searchCustomerID)
      .where('orderCode','==',searchOrderCode);

    const snap = await q.get();
    if(snap.empty){
      container.innerHTML = "Order not found.";
      return;
    }

    container.innerHTML = '';
    snap.forEach(doc=>{
      const order = doc.data();
      order.docPath = doc.ref.path;
      if(!order.status) order.status = "Pending";

      const productsRows = (order.products||[]).map(p=>`
        <tr>
          <td>${p.name}</td>
          <td style="text-align:center;">${p.qty}</td>
          <td style="text-align:right;">$${Number(p.price).toFixed(2)}</td>
          <td style="text-align:right;">$${(p.price*p.qty).toFixed(2)}</td>
        </tr>
      `).join('');

      const invoiceHTML = `
        <div class="invoice">
          <h3>Order: ${order.orderCode}</h3>
          <p><b>Customer:</b> ${order.customer.name}</p>
          <p><b>Phone:</b> ${order.customer.phone}</p>

          <p>Status:
            <span id="status-${doc.id}" class="status ${order.status}">
              ${order.status}
            </span>
          </p>

          <hr>

          <table style="width:100%;">
            <thead>
              <tr><th>Product</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr>
            </thead>
            <tbody>${productsRows}</tbody>
          </table>

          <div style="margin-top:20px;text-align:right;">
            ${order.status === "Pending" ? `
              <button id="confirm-${doc.id}"
                onclick="showModal('Confirm this order?', () => confirmOrder('${order.docPath}','${doc.id}'))"
                style="background:green;color:white;padding:8px 14px;border:none;border-radius:6px;margin-right:10px;">
                Confirm
              </button>

              <button id="cancel-${doc.id}"
                onclick="showModal('Cancel this order?', () => cancelOrder('${order.docPath}','${doc.id}'))"
                style="background:red;color:white;padding:8px 14px;border:none;border-radius:6px;">
                Cancel
              </button>
            ` : ``}
          </div>
        </div>
      `;

      const wrapper = document.createElement('div');
      wrapper.innerHTML = invoiceHTML;
      container.appendChild(wrapper);
    });

  }catch(err){
    console.error(err);
    container.innerHTML = "Error loading order";
  }
}

function updateStatus(orderId, status){
  const statusEl = document.getElementById(`status-${orderId}`);
  if(statusEl){
    statusEl.textContent = status;
    statusEl.className = 'status ' + status;
  }

  const confirmBtn = document.getElementById(`confirm-${orderId}`);
  const cancelBtn = document.getElementById(`cancel-${orderId}`);

  if(confirmBtn) confirmBtn.remove();
  if(cancelBtn) cancelBtn.remove();
}


async function confirmOrder(docPath, orderId){
  try{
    await db.doc(docPath).update({status:"Confirmed"});
    updateStatus(orderId,"Confirmed");
  }catch(err){
    alert("Failed to confirm: "+err.message);
  }
}

async function cancelOrder(docPath, orderId){
  try{
    await db.doc(docPath).update({status:"Cancelled"});
    updateStatus(orderId,"Cancelled");
  }catch(err){
    alert("Failed to cancel: "+err.message);
  }
}


// Helper to update status and remove buttons
function updateStatus(orderId, status){
  const statusEl = document.getElementById(`status-${orderId}`);
  if(statusEl){
    statusEl.textContent = status;
    statusEl.className = 'status ' + status;
  }
  const confirmBtn = document.getElementById(`confirm-${orderId}`);
  const cancelBtn  = document.getElementById(`cancel-${orderId}`);
  if(confirmBtn) confirmBtn.remove();
  if(cancelBtn) cancelBtn.remove();
}

// Confirm order
async function confirmOrder(docPath, orderId){
  try{
    await db.doc(docPath).update({status:"Confirmed"});
    updateStatus(orderId,"Confirmed");
  }catch(err){
    console.error(err);
    alert("Failed to confirm order: "+err.message);
  }
}

// Cancel order
async function cancelOrder(docPath, orderId){
  try{
    await db.doc(docPath).update({status:"Cancelled"});
    updateStatus(orderId,"Cancelled");
  }catch(err){
    console.error(err);
    alert("Failed to cancel order: "+err.message);
  }
}
const chatBtn = document.getElementById('chatBtn');
const chatModal = document.getElementById('chatModal');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');

// Get customerID from URL or order
const customerID = urlParams.get('customerID'); // ប្រើ order customerID
const orderCode  = urlParams.get('orderCode');

chatBtn.addEventListener('click',()=>{ openChat(); });
function closeChat(){ chatModal.style.display='none'; }

// Firestore reference
const chatRef = db.collection('chats').doc(customerID);

// Open chat modal and load messages
function openChat(){
  if(!customerID){ alert("Missing customer ID"); return; }
  chatModal.style.display='flex';
  chatMessages.innerHTML='';
  
  // Listen real-time
  chatRef.onSnapshot(doc=>{
    chatMessages.innerHTML='';
    if(doc.exists){
      const msgs = doc.data().messages || [];
      msgs.forEach(m=>{
        appendMessage(m.text, m.sender);
      });
    }
  });
}

// Append message in DOM
function appendMessage(text, sender='user'){
  const div = document.createElement('div');
  div.textContent = text;
  div.style.marginBottom='6px';
  div.style.padding='6px 10px';
  div.style.borderRadius='8px';
  div.style.maxWidth='80%';
  div.style.wordBreak='break-word';
  div.style.alignSelf = sender==='user'?'flex-end':'flex-start';
  div.style.background = sender==='user'?'#0c8aa8':'#f1f1f1';
  div.style.color = sender==='user'?'white':'#222';
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Send message
async function sendMessage(){
  const text = chatInput.value.trim();
  if(!text) return;
  chatInput.value='';
  appendMessage(text,'user');
  
  try{
    await chatRef.set({
      messages: firebase.firestore.FieldValue.arrayUnion({
        text, sender:'user', createdAt: firebase.firestore.Timestamp.now()
      })
    }, {merge:true});
    
    // Optional: admin auto-reply
    // await chatRef.set({
    //   messages: firebase.firestore.FieldValue.arrayUnion({
    //     text:"We received your message!", sender:'admin', createdAt: firebase.firestore.Timestamp.now()
    //   })
    // }, {merge:true});
    
  }catch(err){
    console.error(err);
    alert("Failed to send: "+err.message);
  }
}

// Enter key
chatInput.addEventListener('keydown',e=>{
  if(e.key==='Enter') sendMessage();
});

// Auto fetch when logged in
auth.onAuthStateChanged(u=>{ if(u) fetchOrder(); });
</script>
</body>
</html>
